{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "adminUsername": {
      "type": "string",
      "metadata": {
        "group": "Base Settings",
        "description": "The name of the administrator account for each machine. 'domainadmin' and 'user', 'user_a', 'testuser'  also will be created at each domain defined below"
      },
      "defaultValue": "localadmin"
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "group": "Base Settings",
        "description": "Password for 'localadmin', 'domainadmin', 'user', 'user_a', 'testuser'"
      }
    },
    "ArtifactsLocation": {
      "type": "string",
      "defaultValue": "https://raw.githubusercontent.com/CIThunderChicken/ThunderChicken/TCLight/master-template",
      "metadata": {
        "group": "Base Settings",
        "description": "The base URI where artifacts required by this template are located. When the template is deployed using the accompanying scripts, a private location in the subscription will be used and this value will be automatically generated."
      }      
    },
    "ArtifactsLocationSasToken": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "group": "Base Settings",
        "description": "The sasToken required to access ArtifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated."
      }      
    }, 
    "deployJumpbox": {
      "type": "string",
      "defaultValue": "No",
      "allowedValues": [
        "Yes",
        "No"
      ],
      "metadata": {
        "group": "Jumpbox Settings",
        "description": "Indicates wheter or not include Jumpbox in this deployment"
      }
    },
    "enterpriseGithubUsername": {
      "type": "string",
      "defaultValue": "",   
      "metadata": {
        "group": "Jumpbox Settings",
        "description": "UserName for Enterprise Github connection, Leave empty if Jumpbox is not part of this deployment"
      }
    },  
    "enterpriseGithubToken": {
      "type": "securestring",
      "defaultValue": "",   
      "metadata": {
        "group": "Jumpbox Settings",
        "description": "Token for Enterprise Github connection, Leave empty if Jumpbox is not part of this deployment"
      }
    }, 

    "deployDomain": {
      "type": "string",
      "defaultValue": "No",
      "allowedValues": [
        "Yes",
        "No"
      ],
      "metadata": {
        "group": "Domain Settings",
        "description": "Indicates wheter or not include Domain Controller in this deployment"
      }
    },
    "deployDomainDMZ": {
      "type": "string",
      "defaultValue": "No",
      "allowedValues": [
        "Yes",
        "No"
      ],
      "metadata": {
        "group": "Domain Settings",
        "description": "Indicates wheter or not include DMZ zone Domain  in this deployment"
      }
    },
    "forestMode": {
      "type": "string",
      "defaultValue": "Win2012R2",
      "allowedValues": [
        "WinThreshold",
        "Win2012R2",
        "Win2012",
        "Win2008R2",
        "Win2008"
      ],
      "metadata": {
        "group": "Domain Settings",
        "description": "Domain Controller Functioning Level"
      }
    },
    "ConfiguredSharedService": {
      "type": "string",
      "defaultValue": "None",
      "allowedValues": [
        "None",
        "SQLOnly",
        "SQLandSCOM"
      ],
      "metadata": {
        "group": "Service Settings",
        "description": "Indicates which service layer vms to build and prepare"
      }      
    },   
    "BlankService": {
      "type": "string",
      "defaultValue": "Skype",
      "allowedValues": [
        "None",
        "AD-DS",
        "DNS",
        "NPS",
        "SCOM",
        "SharedSQL",
        "FileServer",
        "DHCP",
        "SharePoint",
        "OOS",
        "Exchange",
        "UEM",
        "Skype"
      ],
      "metadata": {
        "group": "Service Settings",
        "description": "Indicates which service layer vms to build and prepare"
      }
    },
    "IncludeTestEnviornment": {
      "type": "string",
      "defaultValue": "None",
      "allowedValues": [
        "None",
        "Internal Test",
        "External Test"        
      ],
      "metadata": {
        "group": "Service Settings",
        "description": "Includes Internal Test Machines, windows desktop in each site"
      }      
    },    

    "VirtualMachineSizes": {
      "type": "string",
      "defaultValue": "Small",
      "allowedValues": [
        "Small",
        "Medium",
        "Large",
        "Default"
      ],
      "metadata": {
        "group": "VM Settings",
        "description": "Builds virtual machine to T-Shirt size: Small: 1 or 2 cores Core, Medium:4 Core: Large: 8 Cores, Default: T-Shirt sizes defined in each service layer templates."
      }
    },       
    "DiskSizes": {
      "type": "string",
      "defaultValue": "Small-4GB",
      "allowedValues": [
        "Small-4GB",
        "Medium-20GB",
        "Large-50GB" 
      ],
      "metadata": {
        "group": "VM Settings",
        "description": "Configures size of each drives defined in service layers."
      }
    },       
    "OSDiskSize": {
      "type": "string",
      "defaultValue": "Small-30GB",
      "allowedValues": [
        "Small-30GB",
        "Regular-127GB"        
      ],
      "metadata": {
        "group": "VM Settings",
        "description": "Defines Windows OS disk size. Small is for development, Reguler is full capacity tests"
      }
    },       
    "VMSeries": {
      "type": "string",
      "defaultValue": "Dv3-Series",
      "allowedValues": [
        "Dv3-Series",
        "Dv2-Series",
        "Bs-Series"
      ],
      "metadata": {
        "group": "VM Settings",
        "description": "Defines Azure VM Series - CPU and memory optimization."
      }
    },    
    "AutoShutdown": {
      "type": "string",
      "defaultValue": "1800",
      "allowedValues": [
        "1200",
        "1300",
        "1400",
        "1500",
        "1600",
        "1700",
        "1800",
        "1900",
        "2000"
      ],
      "metadata": {
        "group": "VM Settings",
        "description": "Daily Auto Shutdown schedule for each vms."
      }
    }
  },
  "variables": {    
    "location": "[resourceGroup().location]",    
    "deployJumpBoxTemplate":"[parameters('deployJumpbox')]",
    "IncludeTestEnviornment" : "[parameters('IncludeTestEnviornment')]", 
    "domainName": "Domain.com",
    "domainNetbiosName": "Domain",
    "domainNameDMZ": "DomainDmz.com",
    "domainNetbiosNameDMZ": "DomainDmz",
    "domainAdminUsername" : "domainadmin",    
    "template" : "[parameters('BlankService')]",
    "SharedService" : "[parameters('ConfiguredSharedService')]",
    "forestMode": "[parameters('forestMode')]",    
    "baseTemplateUrl": "[concat(parameters('ArtifactsLocation'),'/nestedtemplates/','ProvisionBase.json', parameters('ArtifactsLocationSasToken'))]",
    "jumpboxTemplateUrl": "[concat(parameters('ArtifactsLocation'),'/nestedtemplates/','ProvisionJumpbox.json', parameters('ArtifactsLocationSasToken'))]",
    "publicIpTemplateUrl": "[concat(parameters('ArtifactsLocation'),'/nestedtemplates/','ProvisionPublicIPs.json', parameters('ArtifactsLocationSasToken'))]",
    "loadBalancersTemplateUrl": "[concat(parameters('ArtifactsLocation'),'/nestedtemplates/','ProvisionLoadBalancers.json', parameters('ArtifactsLocationSasToken'))]",    
    "domainTemplateUrl": "[concat(parameters('ArtifactsLocation'),'/nestedtemplates/','ProvisionDomain.json', parameters('ArtifactsLocationSasToken'))]",
    "domainDMZTemplateUrl": "[concat(parameters('ArtifactsLocation'),'/nestedtemplates/','ProvisionDomainDMZ.json', parameters('ArtifactsLocationSasToken'))]",
    "serviceTemplateUrl": "[concat(parameters('ArtifactsLocation'),'/nestedtemplates/','ProvisionService.json', parameters('ArtifactsLocationSasToken'))]",
    "externalTestTemplateUrl": "[concat(parameters('ArtifactsLocation'),'/nestedtemplates/','ProvisionExternalTest.json', parameters('ArtifactsLocationSasToken'))]",
    "loadBalancingTemplateUrl": "[concat(parameters('ArtifactsLocation'),'/nestedtemplates/','ProvisionLoadBalancers.json', parameters('ArtifactsLocationSasToken'))]",
    "sqlTemplateUrl": "[concat(parameters('ArtifactsLocation'),'/nestedtemplates/','ConfigureSQL.json', parameters('ArtifactsLocationSasToken'))]",
    "scomTemplateUrl": "[concat(parameters('ArtifactsLocation'),'/nestedtemplates/','ConfigureSCOM.json', parameters('ArtifactsLocationSasToken'))]",
    
    "_Comment" : "trying to place all config data here at front.",
    "VSubnetName": "vs",
    "KSubnetName": "ks",
    "CSubnetName": "cs",
    "VSubnetPrefix": "10.0.0.0/24",
    "KSubnetPrefix": "10.0.1.0/24",
    "CSubnetPrefix": "10.0.2.0/24",
    "_conditionfordeploymentDMZ": "[ or( equals(parameters('deployDomainDMZ'), 'Yes'), equals(variables('template'), 'UEM'), equals(variables('IncludeTestEnviornment'), 'External Test') )]",

    "_conditionForLoadbalancing": "[ or( equals(variables('template'), 'Skype'), equals(variables('template'), 'Exchange')  )]",

    "ConfigData": {
      "Domain" : {
        "DomainGroups"  : [],
        "DomainUsers"  : [
          {
            "UserName" : "user",
            "DomainGroups" : [],
            "LocalGroups" : []
          },
          {
            "UserName" : "user_a",
            "DomainGroups" : ["Account Operators"],
            "LocalGroups" : ["Administrators"]
          },
          {
            "UserName" : "testuser",
            "DomainGroups" : [],
            "LocalGroups" : []
          }
        ],
      
        "sites": [        
          {
            "name": "[toUpper(variables('KSubnetName'))]",
            "prefix": "[variables('KSubnetPrefix')]",
            "sitelink": "[concat(toUpper(variables('KSubnetName')),',',toUpper(variables('CSubnetName')))]"
          },
          {
            "name": "[toUpper(variables('VSubnetName'))]",
            "prefix": "[variables('VSubnetPrefix')]",
            "sitelink": "[concat(toUpper(variables('KSubnetName')),',',toUpper(variables('VSubnetName')))]"
          },
          {
            "name": "[toUpper(variables('CSubnetName'))]",
            "prefix": "[variables('CSubnetPrefix')]",
            "sitelink": "[concat(toUpper(variables('CSubnetName')),',',toUpper(variables('VSubnetName')))]"
          }
        ]
      },
      "LoadBalancing" : {
       
      }
    }

  },
  "resources": [
    
    {
      "name": "ProvisioningBase",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('baseTemplateUrl')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "ArtifactsLocation": {
            "value": "[parameters('ArtifactsLocation')]"
          },
          "ArtifactsLocationSasToken": {
            "value": "[parameters('ArtifactsLocationSasToken')]"
          }, 
          "domainAdminUsername": {
            "value": "[variables('domainAdminUsername')]"
          },        
          "domainname": {
            "value": "[variables('domainname')]"
          },
          "domainNetbiosName": {
            "value": "[variables('domainNetbiosName')]"
          },
          "domainNameDMZ": {
            "value": "[variables('domainNameDMZ')]"
          },
          "domainNetbiosNameDMZ": {
            "value": "[variables('domainNetbiosNameDMZ')]"
          }
        }
      }
    },
    {
      "name": "ProvisioningPublicIPs",
      "type": "Microsoft.Resources/deployments",
      "condition": "[ or(equals(variables('template'), 'Exchange'), equals(variables('template'), 'Skype'))]",
      "apiVersion": "2015-01-01",      
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('publicIpTemplateUrl')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {}
      }
    },
    {
      "name": "ProvisionLoadBalancers",
      "type": "Microsoft.Resources/deployments",
      "condition": "[ or(equals(variables('template'), 'Exchange'), equals(variables('template'), 'Skype'))]",
      "apiVersion": "2015-01-01",
      "dependsOn" : [
        "ProvisioningBase",
        "ProvisioningPublicIPs"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('loadBalancersTemplateUrl')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {}
      }
    },   
    {
      "name": "ProvisioningJumbBox",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "condition":  "[equals(variables('deployJumpBoxTemplate'), 'Yes')]",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'ProvisioningBase')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('jumpboxTemplateUrl')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },   
          "domainAdminUsername": {
            "value": "[variables('domainAdminUsername')]"
          },  
          "domainname": {
            "value": "[variables('domainname')]"
          },
          "domainNetbiosName": {
            "value": "[variables('domainNetbiosName')]"
          },
          "domainNameDMZ": {
            "value": "[variables('domainNameDMZ')]"
          },
          "domainNetbiosNameDMZ": {
            "value": "[variables('domainNetbiosNameDMZ')]"
          },               
          "ArtifactsLocation": {
            "value": "[parameters('ArtifactsLocation')]"
          },
          "ArtifactsLocationSasToken": {
            "value": "[parameters('ArtifactsLocationSasToken')]"
          },
          "enterpriseGithubUsername": {
            "value": "[parameters('enterpriseGithubUsername')]"            
          },  
          "enterpriseGithubToken": {
            "value": "[parameters('enterpriseGithubToken')]"           
          },
          "DiskSizes": {
            "value": "[parameters('DiskSizes')]"
          },
          "OSDiskSize": {
            "value": "[parameters('OSDiskSize')]"
          },
          "VMSeries": {
            "value": "[parameters('VMSeries')]"
          },          
          "AutoShutdown": {
            "value": "[parameters('AutoShutdown')]"
          }
        }
      }
    },
    {
      "name": "ProvisioningDomains",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "condition": "[equals(parameters('deployDomain'), 'Yes')]",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'ProvisioningBase')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('domainTemplateUrl')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adminUsername": {
            "value": "[variables('domainAdminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "ArtifactsLocation": {
            "value": "[parameters('ArtifactsLocation')]"
          },
          "ArtifactsLocationSasToken": {
            "value": "[parameters('ArtifactsLocationSasToken')]"
          },
          "VirtualMachineSizes": {
            "value": "[parameters('VirtualMachineSizes')]"
          },
          "DiskSizes": {
            "value": "[parameters('DiskSizes')]"
          },
          "VMSeries": {
            "value": "[parameters('VMSeries')]"
          }, 
          "domainname": {
            "value": "[variables('domainname')]"
          },
          "domainNetbiosName": {
            "value": "[variables('domainNetbiosName')]"
          },
          "forestMode": {
            "value": "[parameters('forestMode')]"
          },          
          "AutoShutdown": {
            "value": "[parameters('AutoShutdown')]"
          },
          "ConfigData" : { 
            "value" : "[variables('ConfigData').Domain]"
          }

        }
      }
    },    
    {
      "name": "ProvisioningDomainsDMZ",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "condition": "[equals(parameters('deployDomainDMZ'), 'Yes')]",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'ProvisioningBase')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('domainDMZTemplateUrl')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adminUsername": {
            "value": "[variables('domainAdminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "ArtifactsLocation": {
            "value": "[parameters('ArtifactsLocation')]"
          },
          "ArtifactsLocationSasToken": {
            "value": "[parameters('ArtifactsLocationSasToken')]"
          },
          "VirtualMachineSizes": {
            "value": "[parameters('VirtualMachineSizes')]"
          },
          "DiskSizes": {
            "value": "[parameters('DiskSizes')]"
          },
          "VMSeries": {
            "value": "[parameters('VMSeries')]"
          },         
          "domainname": {
            "value": "[variables('domainnameDMZ')]"
          },
          "domainNetbiosName": {
            "value": "[variables('domainNetbiosNameDMZ')]"
          },
          "forestMode": {
            "value": "[parameters('forestMode')]"
          },          
          "AutoShutdown": {
            "value": "[parameters('AutoShutdown')]"
          }
        }
      }
    },
    {
      "name": "[concat('Provisioning', variables('template'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "condition": "[not(equals(variables('template'), 'None'))]",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'ProvisioningBase')]",
        "[if( or(equals(variables('template'), 'Exchange'), equals(variables('template'), 'Skype'))   , 'ProvisionLoadBalancers' ,  'ProvisioningBase')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('serviceTemplateUrl')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "domainAdminUsername": {
            "value": "[variables('domainAdminUsername')]"
          },
          "domainname": {
            "value": "[variables('domainname')]"
          },
          "domainNetbiosName": {
            "value": "[variables('domainNetbiosName')]"
          },
          "domainNameDMZ": {
            "value": "[variables('domainNameDMZ')]"
          },
          "domainNetbiosNameDMZ": {
            "value": "[variables('domainNetbiosNameDMZ')]"
          },
          "ArtifactsLocation": {
            "value": "[parameters('ArtifactsLocation')]"
          },
          "ArtifactsLocationSasToken": {
            "value": "[parameters('ArtifactsLocationSasToken')]"
          },
          "VirtualMachineSizes": {
            "value": "[parameters('VirtualMachineSizes')]"
          },
          "DiskSizes": {
            "value": "[parameters('DiskSizes')]"
          },
          "OSDiskSize": {
            "value": "[parameters('OSDiskSize')]"
          },
          "VMSeries": {
            "value": "[parameters('VMSeries')]"
          }, 
          "template": {
            "value": "[variables('template')]"
          },
          "AutoShutdown": {
            "value": "[parameters('AutoShutdown')]"
          }
        }
      }
    },    
    {
      "name": "ProvisioningInternalTest",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "condition": "[equals(variables('IncludeTestEnviornment'), 'Internal Test')]",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'ProvisioningBase')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('serviceTemplateUrl')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "domainAdminUsername": {
            "value": "[variables('domainAdminUsername')]"
          },
          "domainname": {
            "value": "[variables('domainname')]"
          },
          "domainNetbiosName": {
            "value": "[variables('domainNetbiosName')]"
          },
          "domainNameDMZ": {
            "value": "[variables('domainNameDMZ')]"
          },
          "domainNetbiosNameDMZ": {
            "value": "[variables('domainNetbiosNameDMZ')]"
          },
          "ArtifactsLocation": {
            "value": "[parameters('ArtifactsLocation')]"
          },
          "ArtifactsLocationSasToken": {
            "value": "[parameters('ArtifactsLocationSasToken')]"
          },
          "VirtualMachineSizes": {
            "value": "[parameters('VirtualMachineSizes')]"
          },
          "DiskSizes": {
            "value": "[parameters('DiskSizes')]"
          },
          "OSDiskSize": {
            "value": "[parameters('OSDiskSize')]"
          },
          "VMSeries": {
            "value": "[parameters('VMSeries')]"
          }, 
          "template": {
            "value": "InternalTest"
          },
          "AutoShutdown": {
            "value": "[parameters('AutoShutdown')]"
          }
        }
      }
    },
    {
      "name": "ProvisioningExternalTest",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "condition": "[equals(variables('IncludeTestEnviornment'), 'External Test')]",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'ProvisioningBase')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('externalTestTemplateUrl')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adminUsername": {
            "value": "[variables('domainAdminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "ArtifactsLocation": {
            "value": "[parameters('ArtifactsLocation')]"
          },
          "ArtifactsLocationSasToken": {
            "value": "[parameters('ArtifactsLocationSasToken')]"
          },
          "VirtualMachineSizes": {
            "value": "[parameters('VirtualMachineSizes')]"
          },
          "DiskSizes": {
            "value": "[parameters('DiskSizes')]"
          },
          "VMSeries": {
            "value": "[parameters('VMSeries')]"
          }, 
          "domainname": {
            "value": "[variables('domainname')]"
          },
          "domainNetbiosName": {
            "value": "[variables('domainNetbiosName')]"
          },
          "forestMode": {
            "value": "[parameters('forestMode')]"
          },          
          "AutoShutdown": {
            "value": "[parameters('AutoShutdown')]"
          },
          "ConfigData" : { 
            "value" : "[variables('ConfigData')]"
          }

        }
      }
    },     
    {
      "name": "ProvisioningSQLFull",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "condition": "[or(equals(variables('SharedService'), 'SQLOnly'),equals(variables('SharedService'), 'SQLandSCOM'))]",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'ProvisioningBase')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('serviceTemplateUrl')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },          
          "domainAdminUsername": {
            "value": "[variables('domainAdminUsername')]"
          },
          "domainname": {
            "value": "[variables('domainname')]"
          },
          "domainNetbiosName": {
            "value": "[variables('domainNetbiosName')]"
          },
          "domainNameDMZ": {
            "value": "[variables('domainNameDMZ')]"
          },
          "domainNetbiosNameDMZ": {
            "value": "[variables('domainNetbiosNameDMZ')]"
          },
          "ArtifactsLocation": {
            "value": "[parameters('ArtifactsLocation')]"
          },
          "ArtifactsLocationSasToken": {
            "value": "[parameters('ArtifactsLocationSasToken')]"
          },
          "VirtualMachineSizes": {
            "value": "[parameters('VirtualMachineSizes')]"
          },
          "DiskSizes": {
            "value": "[parameters('DiskSizes')]"
          },
          "OSDiskSize": {
            "value": "[parameters('OSDiskSize')]"
          },
          "VMSeries": {
            "value": "[parameters('VMSeries')]"
          }, 
          "template": {
            "value": "SharedSQL"
          },
          "AutoShutdown": {
            "value": "[parameters('AutoShutdown')]"
          }
        }
      }
    },    
    {
      "name": "ConfigureSQL",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "condition": "[or(equals(variables('SharedService'), 'SQLOnly'),equals(variables('SharedService'), 'SQLandSCOM'))]",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'ProvisioningSQLFull')]"        
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('sqlTemplateUrl')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "domainAdminUsername": {
            "value": "[variables('domainAdminUsername')]"
          },
          "domainname": {
            "value": "[variables('domainname')]"
          },
          "domainNetbiosName": {
            "value": "[variables('domainNetbiosName')]"
          },
          "domainNameDMZ": {
            "value": "[variables('domainNameDMZ')]"
          },
          "domainNetbiosNameDMZ": {
            "value": "[variables('domainNetbiosNameDMZ')]"
          },
          "ArtifactsLocation": {
            "value": "[parameters('ArtifactsLocation')]"
          },
          "ArtifactsLocationSasToken": {
            "value": "[parameters('ArtifactsLocationSasToken')]"
          },         
          "template": {
            "value": "SharedSQL"
          }
        }
      }
    },    
    {
      "name": "ProvisioningSCOMFull",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "condition": "[equals(variables('SharedService'), 'SQLandSCOM')]",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'ProvisioningBase')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('serviceTemplateUrl')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "domainAdminUsername": {
            "value": "[variables('domainAdminUsername')]"
          },
          "domainname": {
            "value": "[variables('domainname')]"
          },
          "domainNetbiosName": {
            "value": "[variables('domainNetbiosName')]"
          },
          "domainNameDMZ": {
            "value": "[variables('domainNameDMZ')]"
          },
          "domainNetbiosNameDMZ": {
            "value": "[variables('domainNetbiosNameDMZ')]"
          },
          "ArtifactsLocation": {
            "value": "[parameters('ArtifactsLocation')]"
          },
          "ArtifactsLocationSasToken": {
            "value": "[parameters('ArtifactsLocationSasToken')]"
          },
          "VirtualMachineSizes": {
            "value": "[parameters('VirtualMachineSizes')]"
          },
          "DiskSizes": {
            "value": "[parameters('DiskSizes')]"
          },
          "OSDiskSize": {
            "value": "[parameters('OSDiskSize')]"
          },
          "VMSeries": {
            "value": "[parameters('VMSeries')]"
          }, 
          "template": {
            "value": "SCOM"
          },
          "AutoShutdown": {
            "value": "[parameters('AutoShutdown')]"
          }
        }
      }
    },    
    {
      "name": "ConfigureSCOM",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "condition": "[equals(variables('SharedService'), 'SQLandSCOM')]",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'ProvisioningSCOMFull')]"        
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('scomTemplateUrl')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "domainAdminUsername": {
            "value": "[variables('domainAdminUsername')]"
          },
          "domainname": {
            "value": "[variables('domainname')]"
          },
          "domainNetbiosName": {
            "value": "[variables('domainNetbiosName')]"
          },
          "domainNameDMZ": {
            "value": "[variables('domainNameDMZ')]"
          },
          "domainNetbiosNameDMZ": {
            "value": "[variables('domainNetbiosNameDMZ')]"
          },
          "ArtifactsLocation": {
            "value": "[parameters('ArtifactsLocation')]"
          },
          "ArtifactsLocationSasToken": {
            "value": "[parameters('ArtifactsLocationSasToken')]"
          },
          "template": {
            "value": "SCOM"
          }
        }
      }
    }    
  ],
  "outputs": {}
}