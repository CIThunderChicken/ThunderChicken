{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {},
  "variables": {
    "templatePrefix": "master",
    "virtualNetworkName": "[concat(variables('templatePrefix'), '-vn')]",
    "VSubnetName": "vs",
    "KSubnetName": "ks",
    "CSubnetName": "cs",
    "CDMZSubnetName": "cdmz",
    "KDMZSubnetName": "kdmz",
    "LoadBalancers"   : [  
      {     
        "Name" : "K",
        "Site" : "ks",        
        "Type" : "Internal",
        "SKU"  : "Basic",            
        "frontendIPConfigurations": [
          {
              "name": "FronEndExchangeMailBoxK",            
              "properties": {                  
                  "privateIPAddress": "10.0.1.200",
                  "privateIPAllocationMethod": "Static",
                  "subnet": {                      
                      "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('virtualNetworkName'),  variables('KSubnetName'))]"
                  },
                  "privateIPAddressVersion": "IPv4"
              }
          },
          {
              "name": "FronEndSkypeK",            
              "properties": {                  
                  "privateIPAddress": "10.0.1.201",
                  "privateIPAllocationMethod": "Static",
                  "subnet": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('virtualNetworkName'),  variables('KSubnetName'))]"
                  },
                  "privateIPAddressVersion": "IPv4"
              }
          }         
        ],
        "backendAddressPools": [
          {
            "name": "backendpoolMailBoxK",            
            "properties": {
            }
          },         
          {
            "name": "backendpoolSkypeK",            
            "properties": {                
            }
          }
        ],
        "inboundNatRules": [],
        "loadBalancingRules": [
            {
              "name": "loadBalancingRulesMailBoxK80",              
              "properties": {                  
                  "frontendIPConfiguration": {
                      "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'K', '-loadbalancer')), '/frontendIPConfigurations/FronEndExchangeMailBoxK')]"
                  },
                  "frontendPort": 80,
                  "backendPort": 80,
                  "enableFloatingIP": false,
                  "idleTimeoutInMinutes": 4,
                  "protocol": "Tcp",
                  "enableTcpReset": false,
                  "loadDistribution": "Default",
                  "backendAddressPool": {
                      "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'K', '-loadbalancer')), '/backendAddressPools/backendpoolMailBoxK')]"
                  },
                  "probe": {
                      "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'K', '-loadbalancer')), '/probes/HealthProbe80')]"
                  }
              }
            },
            {
              "name": "loadBalancingRulesSkypeK80",              
              "properties": {                  
                  "frontendIPConfiguration": {
                      "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'K', '-loadbalancer')), '/frontendIPConfigurations/FronEndSkypeK')]"
                  },
                  "frontendPort": 80,
                  "backendPort": 80,
                  "enableFloatingIP": false,
                  "idleTimeoutInMinutes": 4,
                  "protocol": "Tcp",
                  "enableTcpReset": false,
                  "loadDistribution": "Default",
                  "backendAddressPool": {
                      "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'K', '-loadbalancer')), '/backendAddressPools/backendpoolSkypeK')]"
                  },
                  "probe": {
                      "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'K', '-loadbalancer')), '/probes/HealthProbe80')]"
                  }
              }
            }
        ],
        "probes": [
            {
              "name": "HealthProbe80",              
              "properties": {              
                  "protocol": "Tcp",
                  "port": 80,
                  "intervalInSeconds": 5,
                  "numberOfProbes": 2
              }
          }
        ]
      },        
      {     
        "Name" : "C",
        "Site" : "cs",
        "Type" : "Internal",          
        "SKU"  : "Basic",
        "frontendIPConfigurations": [
          {
            "name": "FronEndExchangeMailBoxC",            
            "properties": {
                "provisioningState": "Succeeded",
                "privateIPAddress": "10.0.2.200",
                "privateIPAllocationMethod": "Static",
                "subnet": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('virtualNetworkName'),  variables('CSubnetName'))]"
                },
                "privateIPAddressVersion": "IPv4"
            }
          },
          {
            "name": "FronEndSkypeC",            
            "properties": {                
                "privateIPAddress": "10.0.2.201",
                "privateIPAllocationMethod": "Static",
                "subnet": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('virtualNetworkName'),  variables('CSubnetName'))]"
                },
                "privateIPAddressVersion": "IPv4"
            }
          }          
        ],
        "backendAddressPools": [         
          {
            "name": "backendpoolMailBoxC",
            "properties": {                
            }
          },
          {
            "name": "backendpoolSkypeC",            
            "properties": {                
            }
          }
          
        ],
        "inboundNatRules": [],
        "loadBalancingRules": [
          {
            "name": "loadBalancingRulesMailBoxC80",              
            "properties": {                  
                "frontendIPConfiguration": {
                    "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'C', '-loadbalancer')), '/frontendIPConfigurations/FronEndExchangeMailBoxC')]"
                },
                "frontendPort": 80,
                "backendPort": 80,
                "enableFloatingIP": false,
                "idleTimeoutInMinutes": 4,
                "protocol": "Tcp",
                "enableTcpReset": false,
                "loadDistribution": "Default",
                "backendAddressPool": {
                    "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'C', '-loadbalancer')), '/backendAddressPools/backendpoolMailBoxC')]"
                },
                "probe": {
                    "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'C', '-loadbalancer')), '/probes/HealthProbe80')]"
                }
            }
          },
          {
            "name": "loadBalancingRulesSkypeC80",              
            "properties": {                  
                "frontendIPConfiguration": {
                    "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'C', '-loadbalancer')), '/frontendIPConfigurations/FronEndSkypeC')]"
                },
                "frontendPort": 80,
                "backendPort": 80,
                "enableFloatingIP": false,
                "idleTimeoutInMinutes": 4,
                "protocol": "Tcp",
                "enableTcpReset": false,
                "loadDistribution": "Default",
                "backendAddressPool": {
                    "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'C', '-loadbalancer')), '/backendAddressPools/backendpoolSkypeC')]"
                },
                "probe": {
                    "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'C', '-loadbalancer')), '/probes/HealthProbe80')]"
                }
            }
          }          
        ],
        "probes": [
          {
            "name": "HealthProbe80",              
            "properties": {              
                "protocol": "Tcp",
                "port": 80,
                "intervalInSeconds": 5,
                "numberOfProbes": 2
            }
          }          
        ]
      },
      {
        "Name" : "KDMZ",     
        "Site" : "kdmz",
        "Type" : "Internal",          
        "SKU"  : "Basic",
        "frontendIPConfigurations": [
          
          {
            "name": "FronEndExchangeEdgeKDMZ",            
            "properties": {
                "provisioningState": "Succeeded",
                "privateIPAddress": "10.0.3.200",
                "privateIPAllocationMethod": "Static",
                "subnet": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('virtualNetworkName'),  variables('KDMZSubnetName'))]"
                },
                "privateIPAddressVersion": "IPv4"
            }
            
        },
        {
          "name": "FronEndSkypeEdgeKDMZ",            
          "properties": {
              "provisioningState": "Succeeded",
              "privateIPAddress": "10.0.3.201",
              "privateIPAllocationMethod": "Static",
              "subnet": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('virtualNetworkName'),  variables('KDMZSubnetName'))]"
              },
              "privateIPAddressVersion": "IPv4"
          }
        }       
        ],
        "backendAddressPools": [
          {
            "name": "backendpoolExchEdgeKDMZ",
            "properties": {                
            }
          }, 
          {
            "name": "backendpoolSkypeEdgeKDMZ",
            "properties": {                
            }
          }            
        ],
        "inboundNatRules": [],
        "loadBalancingRules": [
          {
            "name": "loadBalancingRulesExchEdgeKDMZ80",              
            "properties": {                  
                "frontendIPConfiguration": {
                    "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'KDMZ', '-loadbalancer')), '/frontendIPConfigurations/FronEndExchangeEdgeKDMZ')]"
                },
                "frontendPort": 80,
                "backendPort": 80,
                "enableFloatingIP": false,
                "idleTimeoutInMinutes": 4,
                "protocol": "Tcp",
                "enableTcpReset": false,
                "loadDistribution": "Default",
                "backendAddressPool": {
                    "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'KDMZ', '-loadbalancer')), '/backendAddressPools/backendpoolExchEdgeKDMZ')]"
                },
                "probe": {
                    "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'KDMZ', '-loadbalancer')), '/probes/HealthProbe80')]"
                }
            }
          },
          {
            "name": "loadBalancingRulesSkypeEdgeKDMZ80",              
            "properties": {                  
                "frontendIPConfiguration": {
                    "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'KDMZ', '-loadbalancer')), '/frontendIPConfigurations/FronEndSkypeEdgeKDMZ')]"
                },
                "frontendPort": 80,
                "backendPort": 80,
                "enableFloatingIP": false,
                "idleTimeoutInMinutes": 4,
                "protocol": "Tcp",
                "enableTcpReset": false,
                "loadDistribution": "Default",
                "backendAddressPool": {
                    "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'KDMZ', '-loadbalancer')), '/backendAddressPools/backendpoolSkypeEdgeKDMZ')]"
                },
                "probe": {
                    "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'KDMZ', '-loadbalancer')), '/probes/HealthProbe80')]"
                }
            }
          }          
        ],
        "probes": [
          {
            "name": "HealthProbe80",              
            "properties": {              
                "protocol": "Tcp",
                "port": 80,
                "intervalInSeconds": 5,
                "numberOfProbes": 2
            }
          }          
        ]
      },
      {     
        "Name" : "CDMZ",
        "Site" : "cdmz",
        "Type" : "Internal",          
        "SKU"  : "Basic",
        "frontendIPConfigurations": [
          {
            "name": "FronEndExchangeEdgeCDMZ",            
            "properties": {
                "provisioningState": "Succeeded",
                "privateIPAddress": "10.0.4.200",
                "privateIPAllocationMethod": "Static",
                "subnet": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('virtualNetworkName'),  variables('CDMZSubnetName'))]"
                },
                "privateIPAddressVersion": "IPv4"
            }
          },
          {
            "name": "FronEndSkypeEdgeCDMZ",            
            "properties": {
                "provisioningState": "Succeeded",
                "privateIPAddress": "10.0.4.201",
                "privateIPAllocationMethod": "Static",
                "subnet": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('virtualNetworkName'),  variables('CDMZSubnetName'))]"
                },
                "privateIPAddressVersion": "IPv4"
            }
          }       
         
        ],
        "backendAddressPools": [
          {
            "name": "backendpoolExchEdgeCDMZ",
            "properties": {                
            }
          },        
          {
            "name": "backendpoolSkypeEdgeCDMZ",
            "properties": {                
            }
          }
        ],
        "inboundNatRules": [],
        "loadBalancingRules": [
          {
            "name": "loadBalancingRulesExchEdgeCDMZ80",              
            "properties": {                  
                "frontendIPConfiguration": {
                    "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'CDMZ', '-loadbalancer')), '/frontendIPConfigurations/FronEndExchangeEdgeCDMZ')]"
                },
                "frontendPort": 80,
                "backendPort": 80,
                "enableFloatingIP": false,
                "idleTimeoutInMinutes": 4,
                "protocol": "Tcp",
                "enableTcpReset": false,
                "loadDistribution": "Default",
                "backendAddressPool": {
                    "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'CDMZ', '-loadbalancer')), '/backendAddressPools/backendpoolExchEdgeCDMZ')]"
                },
                "probe": {
                    "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'CDMZ', '-loadbalancer')), '/probes/HealthProbe80')]"
                }
            }
          },           
          {
            "name": "loadBalancingRulesSkypeEdgeCDMZ80",              
            "properties": {                  
                "frontendIPConfiguration": {
                    "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'CDMZ', '-loadbalancer')), '/frontendIPConfigurations/FronEndSkypeEdgeCDMZ')]"
                },
                "frontendPort": 80,
                "backendPort": 80,
                "enableFloatingIP": false,
                "idleTimeoutInMinutes": 4,
                "protocol": "Tcp",
                "enableTcpReset": false,
                "loadDistribution": "Default",
                "backendAddressPool": {
                    "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'CDMZ', '-loadbalancer')), '/backendAddressPools/backendpoolSkypeEdgeCDMZ')]"
                },
                "probe": {
                    "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(variables('templatePrefix'), '-', 'CDMZ', '-loadbalancer')), '/probes/HealthProbe80')]"
                }
            }
          }
        ],
        "probes": [
          {
            "name": "HealthProbe80",              
            "properties": {              
                "protocol": "Tcp",
                "port": 80,
                "intervalInSeconds": 5,
                "numberOfProbes": 2
            }
          }          
        ]
      },
      {     
        "Name" : "KDMZPublic",
        "Site" : "kdmz",
        "Type" : "Public",          
        "SKU"  : "Basic",
        "frontendIPConfigurations": [
          {
            "name": "FronEndExchangeEdgeKDMZ",            
            "properties": {
                "provisioningState": "Succeeded",
                "privateIPAllocationMethod": "Dynamic",
                "publicIPAddress": {
                    "id": "[resourceId('Microsoft.Network/publicIPAddresses', concat(variables('templatePrefix'), '-' , 'publicIpExchangeEdgeKDMZ')     )]"
                },
                "privateIPAddressVersion": "IPv4"
            }
         },
         {
            "name": "FronEndSkypeEdgeKDMZ",            
            "properties": {
                "provisioningState": "Succeeded",
                "privateIPAllocationMethod": "Dynamic",
                "publicIPAddress": {
                    "id": "[resourceId('Microsoft.Network/publicIPAddresses', concat(variables('templatePrefix'), '-' , 'publicIpSkypeEdgeKDMZ')     )]"
                },
                "privateIPAddressVersion": "IPv4"
            }
         }
        ],
        "backendAddressPools": [
          {
            "name": "backendpoolExchEdgeKDMZ",
            "properties": {                
            }
          },
          {
            "name": "backendpoolSkypeEdgeKDMZ",
            "properties": {                
            }
          }
        ],
        "inboundNatRules": [],
        "loadBalancingRules": [],
        "probes": [
          {
            "name": "HealthProbe80",              
            "properties": {              
                "protocol": "Tcp",
                "port": 80,
                "intervalInSeconds": 5,
                "numberOfProbes": 2
            }
          }          
        ]
      },          
      {     
        "Name" : "CDMZPublic",
        "Site" : "cdmz",
        "Type" : "Public",          
        "SKU"  : "Basic",
        "frontendIPConfigurations": [
          {
            "name": "FronEndExchangeEdgeCDMZ",            
            "properties": {
                "provisioningState": "Succeeded",
                "privateIPAllocationMethod": "Dynamic",
                "publicIPAddress": {
                    "id": "[resourceId('Microsoft.Network/publicIPAddresses', concat(variables('templatePrefix'), '-' , 'publicIpExchangeEdgeCDMZ')     )]"
                },
                "privateIPAddressVersion": "IPv4"
            }
         },
         {
            "name": "FronEndSkypeEdgeCDMZ",            
            "properties": {
                "provisioningState": "Succeeded",
                "privateIPAllocationMethod": "Dynamic",
                "publicIPAddress": {
                    "id": "[resourceId('Microsoft.Network/publicIPAddresses', concat(variables('templatePrefix'), '-' , 'publicIpSkypeEdgeCDMZ')     )]"
                },
                "privateIPAddressVersion": "IPv4"
            }
         }
        ],
        "backendAddressPools": [
          {
            "name": "backendpoolExchEdgeCDMZ",
            "properties": {                
            }
          },
          {
            "name": "backendpoolSkypeEdgeCDMZ",
            "properties": {                
            }
          }
        ],
        "inboundNatRules": [],
        "loadBalancingRules": [],
        "probes": [
          {
            "name": "HealthProbe80",              
            "properties": {              
                "protocol": "Tcp",
                "port": 80,
                "intervalInSeconds": 5,
                "numberOfProbes": 2
            }
          }          
        ]
      }          
    ]


  },
  "resources": [ 
    {
      "apiVersion": "2015-05-01-preview",
      "name": "[concat(variables('templatePrefix'), '-', variables('LoadBalancers')[copyIndex()].Name, '-loadbalancer')]",
      "type": "Microsoft.Network/loadBalancers",
      "location": "[resourceGroup().location]",      
      "tags": {
        "Service": "LoadBalancers",
        "Site": "[ variables('LoadBalancers')[copyIndex()].Site ]"
      }, 
      "copy": {
        "name": "lbLoop",
        "count": "[length(variables('LoadBalancers'))]"
      },
      "properties": {
        "frontendIPConfigurations": "[variables('LoadBalancers')[copyIndex()].frontendIPConfigurations]",
        "backendAddressPools": "[variables('LoadBalancers')[copyIndex()].backendAddressPools]",
        "inboundNatRules": [],
        "loadBalancingRules": "[variables('LoadBalancers')[copyIndex()].loadBalancingRules]",
        "probes": "[variables('LoadBalancers')[copyIndex()].probes]"
      }
    }   
    
  ],
  "outputs": {}
}